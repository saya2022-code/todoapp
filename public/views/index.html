<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />

    <title>Todoアプリ</title>
  </head>
  
  <body>

    <div class="main">
  <!-- header -->
<header>
<h1 class="headline">
  <a>TO DO リスト</a>
</h1>
<!-- <ul class="nav-list">
  <li class="nav-list-item">
    <a>Home</a>
  </li>
  <li class="nav-list-item">About</li>
  <li class="nav-list-item">Topic</li>
</ul> -->
<div class="button-box">
  <button type="button" class="btn btn-success" id="create-Task" data-toggle="modal" data-target="#createModal">
    ＋タスクを追加</button>
    
  <button id="deadTask-button" class="deadTask-button"></button>
 
  <button id="ongoing-button" class="ongoing-button">進行中で絞り込み</button>

  <button id="deadTask-Cbutton" class="deadTask-Cbutton"></button>
</div>
</header>
<!-- <div class="side">
  <p>サイドバー</p>
</div>  -->
<article>

      <div class="header-box">
  
        <div class="container">
          <!-- Content here -->
          <!-- <button type="button" class="btn btn-success" id="create-Task" data-toggle="modal" data-target="#createModal">
            ＋タスクを追加</button> -->

          <!-- 追加Modal -->
            <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModal" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="createModal">タスク　登録</h5>
                    <button type="button"  class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" id="create-form">
                    <label for="taskName">タスク</label>
                    <input id="taskName" class="form-control" name="taskName"/>
                    <p id="taskName-error"></p>
                    
                    <label for="deadline">期限 <br></label>
                    <input type="date" id="deadline" class="form-control" name="deadline"/>
                    <p></p>

                    <label for="category">カテゴリ <br></label>
                    <select id="category" class="form-control" name="category">
                      <option value="1">生活</option>
                      <option value="2">勉強</option>
                      <option value="3">仕事</option>
                      <option value="4">趣味</option>
                    </select>
                    <label for="tagName">タグ</label>
                      <input id="tagName" class="form-control" name="tagName"/>
                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                    <button type="button" id="register-Task" class="btn btn-primary">登録</button>
                  </div>
                </div>
              </div>
            </div>

          <!-- 更新Modal テスト-->
            <div class="modal fade" id="altermodal" tabindex="-1" role="dialog" aria-labelledby="altermodal" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" >タスクの更新</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">

                    <label for="taskName">タスク</label>
                    <input id="taskName" class="form-control" name="taskName"/>
                    <p id="taskName-error"></p>
                    <label for="deadline">期限</label>
                    <input type="date" id="deadline" class="form-control" name="deadline"/>
                    <p></p>

                    <label for="category">カテゴリ</label>
                    <select id="category" class="form-control" name="category">
                      <option value="1">生活</option>
                      <option value="2">勉強</option>
                      <option value="3">仕事</option>
                      <option value="4">趣味</option>
                    </select>

                    <p></p>
                    <label for="status">ステータス</label>
                    <select id="status" class="form-control" name="status">
                      <option value="1">未完了</option>
                      <option value="2">進行中</option>
                      <option value="3">終了</option>
                    </select>

                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                    <button type="button" id="alter-Task" class="btn btn-primary">保存</button>
                  </div>
                </div>
              </div>
            </div>
          <!-- 削除Modal -->
            <div class="modal fade" id="deletemodal" tabindex="-1" role="dialog" aria-labelledby="deletemodalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="deletemodalLabel">下記のタスクを削除しますか？</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-bodys" id="deletemodal-body">
                    <p id="memo"></p>
                  </div>
                  <div class="deletemodal-footer">
                    <button type="button" id="cancel-button" class="btn btn-secondary btn-sm" data-dismiss="modal">キャンセル</button>
                    <button type="button" id="deletemodal-get" class="btn btn-primary btn-sm">OK</button>
                  </div>
                </div>
              </div>
            </div>
        </div>
      </div>
    

    <div class="search-area">
      <form>
        <input type="text" id="search-text" placeholder="検索ワードを入力">
      </form>
      <div class="search-result">
        <div class="search-result__hit-num"></div>
        <div id="search-result__list"></div>
      </div>
    </div>

  <div class="task-body">
    <div class="taskList" id="taskList">
      

      <table bgcolor="#FFFFFF" id="dead-table">
        <thead>
          <tr class="taskHead">
            <th></th>
            <td >タスク名</td>
            <td >期限</td>
            <td >カテゴリー</td>
            <td>ステータス</td>
            <td>更新・削除</td>
          </tr>
      </thead >
      <tbody id="list-contents" class="list-contents">    
        <!-- この間にreturnが入る -->
      </tbody>
    </table>

     <!-- カウントテーブル -->
     <div class="sticky-top">
      <table class="table table-bordered">
          <tr id="table-count">
              <td>現在のタスク数</td>
              <td>終了済みタスク</td>
              <td>残りのタスク</td>
          </tr>
           <tr>
            <td><span class="totalCount" id="all-count"></span> 個</td>
            <td><span class="cntComp" id="cntComp"></span> 個
              <td><span class="cnt-Left" id="cntLeft"></span> 個</td>
          </tr>
      </table>
</div> <!-- /.countTable -->
    </div>
    
    <!-- カウントテーブル -->
      <!-- <div class="sticky-top">
              <table class="table table-bordered">
                  <tr id="table-count">
                      <td>現在のタスク数</td>
                      <td>終了済みタスク</td>
                      <td>残りのタスク</td>
                  </tr>
                   <tr>
                    <td><span class="totalCount" id="all-count"></span> 個</td>
                    <td><span class="cntComp" id="cntComp"></span> 個
                      <td><span class="cnt-Left" id="cntLeft"></span> 個</td>
                  </tr>
              </table>
      </div> /.countTable -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <script src="../javascripts/add.js"></script>
    <script src="../javascripts/taskCount.js"></script>
    <script src="../javascripts/index.js"></script>
    <script>
      
      //新規登録
      $("#register-Task").on("click", async function() {

        // alert("この内容で登録しますか？");
        const deleteName = $(this).data("delete");
        // if(confirm(`この内容で登録しますか？`) == true){

        //リクエストデータをフォームから取得 -->
        const requestData = {
          taskName : $("#taskName").val(),
          deadline : $("#deadline").val(),
          category : $("#category").val(),
        };
      
        //新規登録APIを実行
      const respons = await httpPost(
        "//" + window.location.host + "/api/tasks",
        requestData
      );

      //画面をリロード
        window.location.reload();
      // }else{
      //   return false;
      // }

      });
    
      //一覧
      $(async function() {
        const data = await httpGet("//" + window.location.host +"/api/list");
        let  cntComp = 0;
        const lists = data.map((item) => {
          console.log(item);
           
          // 日付を 年月日に変換
          const createDate = new Date(item.deadline);
          const year = createDate.getFullYear();
          const month = createDate.getMonth() + 1;
          const day = createDate.getDate();
          const deadline = year + "年" + month + "月" + day + "日";

          //ステータスのvalueをテキストに変える
          const statusValue = item.task_status; 
          var status = ""; 
          var statusClass = "";   
             
          if(statusValue == 1){
           status = "未完了";
           statusClass = "status-red";
          //  document.getElementById("td-head").style.backgroundColor ='red'
          }else if(statusValue == 2){
           status = "進行中";
           statusClass = "status-blue";
          }else if(statusValue == 3){
           status = "終了";
           statusClass = "status-green";
           cntComp += 1;
          }
          console.log(cntComp);

          return `<tr>
                  <div id="tdh">
                  <td width="2%" id="td-head" class=${statusClass}></td>
                  <td width="40%">${item.task_name} <li style="font-size: small;">タグ</li></td>
                  <td width="15%">${deadline}</td>
                  <td width="10%">${item.category_name}</td>
                  <td width="10%">${status}</td>
                  <td width="18%"><button type="button" class="btn btn-primary "data-toggle="modal" data-target="#altermodal" id="altermodal-get" data-id=${item.id}>更新</button>
                  <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deletemodal" data-id=${item.id} data-delete=${item.task_name} id="delete-button" >削除</button></td>
                  </div>
                  </tr>`;    
        });
        $(".list-contents").append(lists);
        $(".cntComp").append(cntComp);

        
        //タスクの総数をカウント(cntAll)
        var cntAll = document.getElementById("list-contents").childElementCount;
        document.getElementById("all-count").innerHTML = cntAll;

        //完了したタスク(cntComp)
        // 残タスク数(cntAll-cntComp)
        var cntLeft = cntAll-cntComp;
        // console.log(cntLeft);
        document.getElementById("cntLeft").innerHTML = cntLeft
      });

    //1件取得
    $(document).on("click","#altermodal-get",async function(){
      const id = $(this).data("id");
      const response = await httpGet(        
        "//" + window.location.host + `/api/list/${id}`,
      );
      console.log(response);

    //日付を 年月日に変換
      const date = new Date(response[0].deadline);
      const year = date.getFullYear();
      const month = ("0" + (date.getMonth() + 1)).slice(-2);
      const day = ("0" + date.getDate()).slice(-2);
      const deadline = `${year}-${month}-${day}`;

      console.log($("#altermodal input[name=id]"));
    //初期値のセット
     $("#altermodal input[name=id]").val(response[0].id);
     $("#altermodal input[name=taskName]").val(response[0].task_name);
     $("#altermodal input[name=deadline]").val(deadline);
     $("#altermodal select[name=category]").val(response[0].category_id);
     $("#altermodal select[name=status]").val(response[0].task_status);
    });

      //更新ボタン→保存ボタン
      $(document).on("click","#altermodal-get",async function(){
      $("#alter-Task").data("id",$(this).data("id"));
      console.log($("#alter-Task").data("id")); //この3行だとID取得できる
      });

        //保存ボタンを押した時の処理
        $('#alter-Task').on("click",async function(){
          console.log($(this).data("id")); //成功(deleteと同じ構成で書くと良い)

        //リクエストデータをフォームから取得 -->
        const requestData = {
          taskName : $("#altermodal input[name=taskName]").val(),
          deadline : $("#altermodal input[name=deadline]").val(),
          category : $("#altermodal select[name=category]").val(),
          status : $("#altermodal select[name=status]").val(),
        };

        //更新APIを実行
          const response = await httpUpdate(
          "//" + window.location.host + `/api/list/${$(this).data("id")}`,
          requestData
          );
          console.log(response);
         
          //画面をリロード
          window.location.reload();
          
    });


    //削除ボタン→okボタン
      $(document).on("click","#delete-button",async function(){
      
      $("#deletemodal-get").data("id",$(this).data("id"));
      $("#deletemodal-body").data("delete",$(this).data("delete")); //第2引数までdeleteをセットする必要
      console.log($(this).data("id"));  
      console.log($("#deletemodal-body").data("delete"));//taskNameを取れた    
      
      var str = $("#deletemodal-body").data("delete");
      document.getElementById('deletemodal-body').innerHTML = str ; //モーダルにテキスト表示成功！

    });


    //okボタンを押した時の処理
    $('#deletemodal-get').on("click",async function(){
      console.log($(this).data("id"));
      
    //削除APIを実行
     const response = await httpDelete(        
    "//" + window.location.host + `/api/list/${$(this).data("id")}`,
    );
      console.log(response);

      //画面をリロード
      window.location.reload();
    });
 
  </script>
  </body>
</div>
</article>

<footer>
    <h3 class="h6">閲覧推奨環境</h3>
    <div class="small">
        <p><a href="https://github.com/kde-space/TO_DO_APP" target="_blank">その他使い方などはこちら</a>
        </p>
    </div>
</footer>
</html>
